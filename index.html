<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learn English With Object Detection</title>
    <style>
        :root {
            --primary-color: #4a6da7;
            --secondary-color: #f8f9fa;
            --accent-color: #28a745;
            --text-color: #333;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            overflow: hidden;
        }
        
        .app-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .app-title {
            color: var(--primary-color);
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .app-description {
            color: #666;
            font-size: 16px;
        }
        
        /* ·∫®n video nh∆∞ng v·∫©n ho·∫°t ƒë·ªông */
        video {
            position: absolute;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }
        
        canvas {
            display: none;
        }
        
        .camera-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
        }
        
        .camera-label {
            font-weight: 600;
            margin-right: 10px;
        }
        
        select, button {
            padding: 12px 20px;
            border: none;
            border-radius: 30px;
            background-color: white;
            color: var(--primary-color);
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        select {
            min-width: 200px;
        }
        
        select:focus, button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 109, 167, 0.3);
        }
        
        button:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .result-container {
            text-align: center;
            position: relative;
        }
        
        .result-image {
            width: 100%;
            max-width: 700px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin: 10px auto;
            display: block;
            transition: transform 0.3s ease;
        }
        
        .result-image:hover {
            transform: scale(1.02);
        }
        
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ccc;
        }
        
        .status-indicator.connected {
            background-color: var(--accent-color);
        }
        
        .status-indicator.disconnected {
            background-color: #dc3545;
        }
        
        .status-message {
            margin-top: 15px;
            padding: 10px;
            text-align: center;
            border-radius: var(--border-radius);
            background-color: var(--secondary-color);
            font-size: 14px;
        }
        
        .loading-spinner {
            display: none;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(74, 109, 167, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .detected-objects {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
        }
        
        .detected-objects h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .object-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .object-item {
            background-color: white;
            border-radius: 20px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .object-name {
            font-weight: 600;
            margin-right: 5px;
        }
        
        .object-translation {
            color: #666;
            font-size: 14px;
        }
        
        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .app-title {
                font-size: 24px;
            }
            
            select, button {
                width: 100%;
                padding: 10px 15px;
            }
            
            .camera-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <h1 class="app-title">Learn English With Object Detection</h1>
            <p class="app-description">H·ªçc ti·∫øng Anh th√¥ng qua nh·∫≠n di·ªán v·∫≠t th·ªÉ b·∫±ng camera</p>
        </div>
        
        <div class="camera-controls">
            <label for="cameraSelect" class="camera-label">Ch·ªçn Camera:</label>
            <select id="cameraSelect"></select>
        </div>
        
        <div class="result-container">
            <div id="statusIndicator" class="status-indicator"></div>
            <div class="loading-spinner" id="loadingSpinner"></div>
            <img id="result" class="result-image" alt="K·∫øt qu·∫£ nh·∫≠n di·ªán" src="/api/placeholder/700/400">
            <div id="statusMessage" class="status-message">ƒêang k·∫øt n·ªëi...</div>
        </div>
        
        <div class="detected-objects" id="detectedObjects">
            <h3>C√°c v·∫≠t th·ªÉ ƒë√£ nh·∫≠n di·ªán</h3>
            <div class="object-list" id="objectList">
                <!-- Danh s√°ch ƒë·ªëi t∆∞·ª£ng s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
            </div>
        </div>
    </div>

    <video id="video" autoplay playsinline></video>  <!-- Video b·ªã ·∫©n nh∆∞ng v·∫´n ch·∫°y -->
    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const resultImg = document.getElementById('result');
        const cameraSelect = document.getElementById('cameraSelect');
        const ctx = canvas.getContext('2d');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusMessage = document.getElementById('statusMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const objectList = document.getElementById('objectList');

        let currentStream = null;
        let ws = null;
        let isProcessing = false;
        let animationFrameId = null;
        let isCameraStable = false; // Ki·ªÉm tra xem camera ƒë√£ s·∫µn s√†ng ch∆∞a
        let detectedObjects = []; // Danh s√°ch c√°c ƒë·ªëi t∆∞·ª£ng ƒë√£ nh·∫≠n di·ªán

        function connectWebSocket() {
            statusMessage.textContent = "ƒêang k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß...";
            statusIndicator.className = "status-indicator";

            ws = new WebSocket("wss://1de5-2405-4803-dabb-cba0-260a-5511-34c4-7c7f.ngrok-free.app/ws");

            ws.onopen = () => {
                console.log("‚úÖ WebSocket Connected");
                statusIndicator.className = "status-indicator connected";
                statusMessage.textContent = "ƒê√£ k·∫øt n·ªëi! ƒêang nh·∫≠n di·ªán v·∫≠t th·ªÉ...";
            };

            ws.onerror = (error) => {
                console.error("‚ùå WebSocket Error:", error);
                statusIndicator.className = "status-indicator disconnected";
                statusMessage.textContent = "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau!";
            };

            ws.onclose = () => {
                statusIndicator.className = "status-indicator disconnected";
                statusMessage.textContent = "K·∫øt n·ªëi ƒë√£ b·ªã ƒë√≥ng. ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...";
                
                // Th·ª≠ k·∫øt n·ªëi l·∫°i sau 5 gi√¢y
                setTimeout(connectWebSocket, 5000);
            };

            ws.onmessage = (event) => {
                try {
                    // Gi·∫£ ƒë·ªãnh r·∫±ng d·ªØ li·ªáu tr·∫£ v·ªÅ c√≥ c·∫•u tr√∫c JSON v·ªõi h√¨nh ·∫£nh v√† danh s√°ch ƒë·ªëi t∆∞·ª£ng
                    // N·∫øu API c·ªßa b·∫°n ch·ªâ tr·∫£ v·ªÅ ·∫£nh, b·∫°n c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh ph·∫ßn n√†y
                    const data = JSON.parse(event.data);
                    
                    if (data.image) {
                        resultImg.src = "data:image/jpeg;base64," + data.image;
                    } else {
                        resultImg.src = "data:image/jpeg;base64," + event.data;
                    }
                    
                    // C·∫≠p nh·∫≠t danh s√°ch ƒë·ªëi t∆∞·ª£ng n·∫øu c√≥
                    if (data.objects) {
                        updateDetectedObjects(data.objects);
                    }
                } catch (e) {
                    // N·∫øu d·ªØ li·ªáu kh√¥ng ph·∫£i JSON, gi·∫£ ƒë·ªãnh ƒë√≥ l√† h√¨nh ·∫£nh tr·ª±c ti·∫øp
                    resultImg.src = "data:image/jpeg;base64," + event.data;
                }
                
                loadingSpinner.style.display = "none";
                isProcessing = false;
            };
        }

        function updateDetectedObjects(objects) {
            detectedObjects = objects;
            objectList.innerHTML = '';
            
            objects.forEach(obj => {
                const objectItem = document.createElement('div');
                objectItem.className = 'object-item';
                
                const objectName = document.createElement('span');
                objectName.className = 'object-name';
                objectName.textContent = obj.name || obj.label;
                
                const objectTranslation = document.createElement('span');
                objectTranslation.className = 'object-translation';
                objectTranslation.textContent = obj.translation || `(${obj.confidence.toFixed(2)})`;
                
                objectItem.appendChild(objectName);
                objectItem.appendChild(objectTranslation);
                objectList.appendChild(objectItem);
            });
        }

        async function getCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                cameraSelect.innerHTML = "";
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });

                // ∆Øu ti√™n camera sau n·∫øu c√≥
                const backCamera = videoDevices.find(device => 
                    device.label.toLowerCase().includes("back") || 
                    device.label.toLowerCase().includes("sau") ||
                    device.label.toLowerCase().includes("rear")
                );
                startCamera(backCamera ? backCamera.deviceId : videoDevices[0]?.deviceId);
            } catch (error) {
                console.error("‚ùå L·ªói khi l·∫•y danh s√°ch camera:", error);
                statusMessage.textContent = "Kh√¥ng th·ªÉ l·∫•y danh s√°ch camera. Ki·ªÉm tra quy·ªÅn truy c·∫≠p.";
            }
        }

        async function startCamera(deviceId) {
            // üõë 1. D·ª´ng g·ª≠i frame khi ƒë·ªïi camera
            isCameraStable = false; // ƒê√°nh d·∫•u camera ch∆∞a ·ªïn ƒë·ªãnh
            loadingSpinner.style.display = "block";
            statusMessage.textContent = "ƒêang kh·ªüi t·∫°o camera...";
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }

            // D·ª´ng stream hi·ªán t·∫°i tr∆∞·ªõc khi m·ªü stream m·ªõi
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            try {
                const constraints = {
                    video: {
                        deviceId: deviceId ? { exact: deviceId } : undefined,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                currentStream = stream;

                // ‚úÖ 2. ƒê·ª£i camera ·ªïn ƒë·ªãnh tr∆∞·ªõc khi g·ª≠i frame (1 gi√¢y)
                setTimeout(() => {
                    isCameraStable = true;
                    statusMessage.textContent = "Camera ƒë√£ s·∫µn s√†ng. ƒêang nh·∫≠n di·ªán...";
                    sendFrameLoop();
                }, 1000);

            } catch (error) {
                console.error("‚ùå L·ªói khi truy c·∫≠p camera:", error);
                statusMessage.textContent = "Kh√¥ng th·ªÉ truy c·∫≠p camera. Ki·ªÉm tra quy·ªÅn ho·∫∑c th·ª≠ tr√¨nh duy·ªát kh√°c!";
                loadingSpinner.style.display = "none";
            }
        }

        function sendFrame() {
            // üõë 3. Ch·ªâ g·ª≠i frame n·∫øu camera ƒë√£ ·ªïn ƒë·ªãnh
            if (!isCameraStable || !ws || ws.readyState !== WebSocket.OPEN || isProcessing) {
                return;
            }

            isProcessing = true;
            loadingSpinner.style.display = "block";
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const frame = canvas.toDataURL("image/jpeg", 0.5).split(',')[1];
            ws.send(frame);
        }

        function sendFrameLoop() {
            sendFrame();
            animationFrameId = requestAnimationFrame(sendFrameLoop);
        }

        cameraSelect.addEventListener("change", () => {
            console.log("üîÑ ƒê·ªïi camera, d·ª´ng g·ª≠i frame...");
            statusMessage.textContent = "ƒêang chuy·ªÉn ƒë·ªïi camera...";
            startCamera(cameraSelect.value);
        });

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(() => {
                getCameras();
                connectWebSocket();
            })
            .catch(error => {
                console.error("‚ùå L·ªói quy·ªÅn camera:", error);
                statusMessage.textContent = "B·∫°n c·∫ßn c·∫•p quy·ªÅn truy c·∫≠p camera ƒë·ªÉ s·ª≠ d·ª•ng ·ª©ng d·ª•ng n√†y.";
                statusIndicator.className = "status-indicator disconnected";
            });
    </script>
</body>
</html>
